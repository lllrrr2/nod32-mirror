<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Сводка зеркала ESET NOD32</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      color-scheme: dark;
      font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      --bg: #0f172a;
      --card: rgba(15, 23, 42, 0.78);
      --border: rgba(148, 163, 184, 0.18);
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.12);
      --text-primary: #e2e8f0;
      --text-muted: #94a3b8;
      --badge-bg: rgba(148, 163, 184, 0.12);
      --badge-text: #cbd5f5;
      --success: #22c55e;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.25), transparent 45%),
        radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.3), transparent 50%),
        var(--bg);
      color: var(--text-primary);
      display: flex;
      justify-content: center;
      padding: 48px 24px 64px;
    }

    main {
      width: min(1200px, 100%);
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    header.hero {
      display: grid;
      gap: 20px;
      padding: 32px 36px;
      border-radius: 28px;
      background: linear-gradient(135deg, rgba(30, 64, 175, 0.6), rgba(56, 189, 248, 0.35));
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 0 40px 120px -50px rgba(56, 189, 248, 0.6);
    }

    header.hero h1 {
      margin: 0;
      font-weight: 700;
      font-size: clamp(2rem, 2vw + 1rem, 2.6rem);
      letter-spacing: 0.02em;
    }

    header.hero p {
      margin: 0;
      color: rgba(226, 232, 240, 0.9);
      max-width: 60ch;
      line-height: 1.6;
    }

    .quick-stats {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .stat-card {
      background: var(--card);
      border-radius: 22px;
      padding: 24px;
      border: 1px solid var(--border);
      backdrop-filter: blur(12px);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .stat-card span.label {
      font-size: 0.85rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .stat-value {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .stat-card strong {
      font-size: 1.8rem;
      font-weight: 700;
    }

    .table-card {
      background: var(--card);
      border-radius: 26px;
      border: 1px solid var(--border);
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .table-card header {
      padding: 24px 28px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .table-card header h2 {
      margin: 0;
      font-size: 1.4rem;
    }

    .table-card header .badge {
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.8rem;
      background: var(--accent-soft);
      color: var(--accent);
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 960px;
    }

    thead {
      position: sticky;
      top: 0;
      background: rgba(15, 23, 42, 0.98);
      backdrop-filter: blur(10px);
      z-index: 2;
    }

    th, td {
      text-align: left;
      padding: 18px 24px;
      font-size: 0.95rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.12);
    }

    th {
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.1em;
      color: var(--text-muted);
    }

    tbody tr {
      transition: background 0.25s ease;
    }

    tbody tr:hover {
      background: rgba(56, 189, 248, 0.06);
    }

    .platform-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .platform-badge {
      padding: 4px 10px;
      border-radius: 18px;
      background: var(--badge-bg);
      color: var(--badge-text);
      font-size: 0.75rem;
      letter-spacing: 0.04em;
    }

    .size {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .size-pretty { font-weight: 600; }

    .info-chip {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 0.75rem;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.2s ease;
      z-index: 20;
      outline: none;
    }

    .info-chip:hover,
    .info-chip:focus-visible { transform: translateY(-1px); }

    .files {
      display: flex;
      gap: 12px;
      align-items: center;
      font-size: 0.9rem;
    }

    .files a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--accent-soft);
      transition: background 0.25s ease;
    }

    .files a:hover { background: rgba(56, 189, 248, 0.25); }

    .files .empty {
      color: var(--text-muted);
      font-style: italic;
    }

    .timestamp { font-weight: 600; }

    .timestamp small {
      display: block;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.12);
      color: var(--success);
      font-weight: 600;
    }

    footer {
      margin-top: 16px;
      color: rgba(148, 163, 184, 0.75);
      font-size: 0.85rem;
      text-align: center;
    }

    #tooltip-portal {
      position: fixed;
      z-index: 9999;
      pointer-events: none;
      padding: 8px 12px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-primary);
      box-shadow: 0 12px 30px -15px rgba(56, 189, 248, 0.45);
      font-size: 0.75rem;
      line-height: 1.2;
      opacity: 0;
      visibility: hidden;
      white-space: nowrap;
      transition: opacity .12s ease;
    }

    @media (max-width: 720px) {
      body { padding: 24px 14px 48px; }

      header.hero {
        padding: 24px;
        border-radius: 24px;
        gap: 16px;
      }

      header.hero h1 { font-size: clamp(1.6rem, 4vw + 1rem, 2.2rem); }

      header.hero p { font-size: 0.95rem; }

      .quick-stats { grid-template-columns: 1fr; }

      .stat-card { padding: 18px; }

      .table-card { border-radius: 22px; }

      .table-card header {
        padding: 20px;
        align-items: flex-start;
        flex-direction: column;
        gap: 10px;
      }

      table, thead, tbody, th, td, tr { display: block; }

      thead { display: none; }

      table { min-width: 0; }

      tbody tr {
        background: rgba(15, 23, 42, 0.75);
        border: 1px solid rgba(148, 163, 184, 0.16);
        border-radius: 18px;
        padding: 18px;
        margin: 0 0 18px 0;
        box-shadow: 0 12px 40px -32px rgba(56, 189, 248, 0.5);
      }

      tbody tr:hover {
        background: rgba(56, 189, 248, 0.12);
      }

      td {
        border: none;
        padding: 10px 0;
        display: grid;
        grid-template-columns: 130px 1fr;
        gap: 12px;
        align-items: baseline;
      }

      td::before {
        content: attr(data-label);
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.12em;
        color: var(--text-muted);
      }

      .platform-badges { justify-content: flex-start; }
      .files { flex-wrap: wrap; }
      .files a { width: fit-content; }
    }
  </style>
</head>
<body>
<main>
  <header class="hero">
    <h1 id="title">ESET NOD32 - зеркало обновлений</h1>
    <p>
      Сводка по локальному зеркалу обновлений: актуальные версии, доступные платформы,
      размер баз и дата последнего успешного синхронизационного запуска.
    </p>
    <div class="quick-stats">
      <article class="stat-card">
        <span class="label">Последнее обновление</span>
        <div class="stat-value">
          <strong id="last-update">—</strong>
        </div>
        <small id="last-update-relative" style="color:var(--text-muted);" data-iso-updated=""></small>
      </article>
      <article class="stat-card">
        <span class="label">Суммарный объём</span>
        <div class="stat-value" id="total-size-wrap">
          <strong id="total-size">—</strong>
        </div>
      </article>
      <article class="stat-card">
        <span class="label">Кол-во веток</span>
        <strong id="versions-count">—</strong>
        <span class="status-pill" id="versions-status">
          <span style="font-size:12px;">●</span> Загружается…
        </span>
      </article>
    </div>
  </header>

  <section class="table-card">
    <header>
      <h2>Версии и платформы</h2>
      <span class="badge" id="table-badge">—</span>
    </header>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Версия</th>
            <th>Платформы</th>
            <th>База</th>
            <th>Размер базы</th>
            <th>Файлы</th>
            <th>Обновлено</th>
          </tr>
        </thead>
        <tbody id="versions-body">
          <tr>
            <td colspan="6" style="text-align:center; padding:48px; color:var(--text-muted);">
              Загружаем данные…
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <footer>
    Создано для локального зеркала обновлений ESET NOD32 · Автоматически заполняется из JSON
  </footer>
</main>

<div id="tooltip-portal" hidden></div>

<script>
  const JSON_PATH = './index.json';

  const els = {
    title: document.getElementById('title'),
    lastAbs: document.getElementById('last-update'),
    lastRel: document.getElementById('last-update-relative'),
    totalSizeWrap: document.getElementById('total-size-wrap'),
    totalSize: document.getElementById('total-size'),
    versionsCount: document.getElementById('versions-count'),
    versionsStatus: document.getElementById('versions-status'),
    tableBadge: document.getElementById('table-badge'),
    tbody: document.getElementById('versions-body'),
    tooltip: document.getElementById('tooltip-portal'),
  };

  const nf = new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 1, maximumFractionDigits: 2 });
  const dtf = new Intl.DateTimeFormat('ru-RU', { dateStyle: 'short', timeStyle: 'medium' });
  const rtf = new Intl.RelativeTimeFormat('ru-RU', { numeric: 'auto', style: 'short' });

  function formatAbsolute(ts) {
    return ts ? dtf.format(new Date(ts)) : '—';
  }

  function formatRelative(iso) {
    if (!iso) return 'нет данных';
    const now = Date.now();
    const t = new Date(iso).getTime();
    let sec = Math.round((t - now) / 1000);
    const abs = Math.abs(sec);
    if (abs < 60) return rtf.format(sec, 'second');
    let min = Math.round(sec / 60);
    if (Math.abs(min) < 60) return rtf.format(min, 'minute');
    let hr = Math.round(min / 60);
    if (Math.abs(hr) < 24) return rtf.format(hr, 'hour');
    let day = Math.round(hr / 24);
    if (Math.abs(day) < 7) return rtf.format(day, 'day');
    let wk = Math.round(day / 7);
    if (Math.abs(wk) < 5) return rtf.format(wk, 'week');
    let mon = Math.round(day / 30);
    if (Math.abs(mon) < 12) return rtf.format(mon, 'month');
    let yr = Math.round(day / 365);
    return rtf.format(yr, 'year');
  }

  function formatBytesIEC(bytes) {
    const num = Number(bytes);
    if (!Number.isFinite(num) || num === 0) return '0 Б';
    const units = ['Б','КиБ','МиБ','ГиБ','ТиБ','ПиБ','ЭиБ','ЗиБ','ЙиБ'];
    const exp = Math.min(Math.floor(Math.log(Math.abs(num)) / Math.log(1024)), units.length - 1);
    const value = Math.abs(num) / Math.pow(1024, exp);
    return `${nf.format(value)} ${units[exp]}`;
  }

  function createPlatformBadges(platforms) {
    const list = Array.isArray(platforms) && platforms.length ? platforms : ['n/a'];
    const wrap = document.createElement('div');
    wrap.className = 'platform-badges';
    list.forEach(p => {
      const b = document.createElement('span');
      b.className = 'platform-badge';
      b.textContent = String(p).toUpperCase();
      wrap.appendChild(b);
    });
    return wrap;
  }

  function createFileLinks(versionKey, files) {
    const { file, dll } = files || {};
    const div = document.createElement('div');
    div.className = 'files';
    const parts = [];
    if (file) {
      const a = document.createElement('a');
      a.href = file;
      a.target = '_blank';
      a.rel = 'noopener';
      a.title = `update.ver для ${versionKey}`;
      a.textContent = 'Файл';
      parts.push(a);
    }
    if (dll) {
      const a = document.createElement('a');
      a.href = dll;
      a.target = '_blank';
      a.rel = 'noopener';
      a.title = `dll/update.ver для ${versionKey}`;
      a.textContent = 'DLL';
      parts.push(a);
    }
    if (!parts.length) {
      const span = document.createElement('span');
      span.className = 'empty';
      span.textContent = '—';
      parts.push(span);
    }
    parts.forEach(p => div.appendChild(p));
    return div;
  }

  function buildInfoChip(bytesValue) {
    const bytesNum = Number(bytesValue);
    const chip = document.createElement('span');
    chip.className = 'info-chip';
    chip.tabIndex = 0;
    chip.setAttribute('role', 'button');
    const raw = Number.isFinite(bytesNum) ? bytesNum.toLocaleString('ru-RU') : '0';
    chip.setAttribute('aria-label', `${raw} байт`);
    chip.dataset.tooltip = `${raw} байт`;
    chip.textContent = 'i';
    return chip;
  }

  function buildSizeCell(bytesValue) {
    const numericBytes = Number(bytesValue);
    const container = document.createElement('div');
    container.className = 'size';

    const pretty = Number.isFinite(numericBytes)
      ? formatBytesIEC(numericBytes)
      : '—';

    const prettySpan = document.createElement('span');
    prettySpan.className = 'size-pretty';
    prettySpan.textContent = pretty;
    container.appendChild(prettySpan);

    if (Number.isFinite(numericBytes)) {
      container.appendChild(buildInfoChip(numericBytes));
    }
    return container;
  }

  function fillHeader(metadata) {
    const { title, last_update, total_size, versions } = metadata || {};
    els.title.textContent = title ?? 'ESET NOD32 - зеркало обновлений';

    els.lastAbs.textContent = formatAbsolute(last_update);

    els.lastRel.textContent = formatRelative(last_update);
    els.lastRel.setAttribute('data-iso-updated', last_update || '');

    const totalBytes = Number(total_size?.bytes);
    els.totalSize.textContent = Number.isFinite(totalBytes) ? formatBytesIEC(totalBytes) : '—';
    els.totalSizeWrap.querySelectorAll('.info-chip').forEach(chip => chip.remove());
    if (Number.isFinite(totalBytes)) {
      els.totalSizeWrap.appendChild(buildInfoChip(totalBytes));
    }

    const versionsCount = versions ? Object.keys(versions).length : 0;
    els.versionsCount.textContent = versionsCount;
    els.tableBadge.textContent = `${versionsCount} веток`;
    els.versionsStatus.innerHTML = `
      <span style="font-size:12px;">●</span>
      ${versionsCount > 0 ? 'Ветки активны' : 'Нет данных'}
    `;
  }

  function fillTable(versions) {
    const body = els.tbody;
    body.textContent = '';

    const entries = Object.entries(versions || {});
    if (!entries.length) {
      body.insertAdjacentHTML('beforeend',
        `<tr><td colspan="6" style="text-align:center; padding:36px; color:var(--text-muted);">
          Нет включённых веток для отображения.
        </td></tr>`);
      return;
    }

    const frag = document.createDocumentFragment();

    for (const [key, data] of entries) {
      const tr = document.createElement('tr');

      const tdVer = document.createElement('td');
      tdVer.setAttribute('data-label', 'Версия');
      tdVer.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:6px;">
          <strong></strong>
          <small style="color:var(--text-muted); font-size:0.8rem;"></small>
        </div>
      `;
      tdVer.querySelector('strong').textContent = data?.name || key;
      tdVer.querySelector('small').textContent = String(key).toUpperCase();

      const tdPlat = document.createElement('td');
      tdPlat.setAttribute('data-label', 'Платформы');
      tdPlat.appendChild(createPlatformBadges(data?.platforms));

      const tdDb = document.createElement('td');
      tdDb.setAttribute('data-label', 'База');
      tdDb.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:4px;">
          <span style="font-weight:600; font-size:1rem;"></span>
          <small style="color:var(--text-muted); font-size:0.8rem;">Version ID</small>
        </div>
      `;
      tdDb.querySelector('span').textContent = data?.database?.version ?? '—';

      const tdSize = document.createElement('td');
      tdSize.setAttribute('data-label', 'Размер базы');
      tdSize.appendChild(buildSizeCell(data?.database?.size?.bytes));

      const tdFiles = document.createElement('td');
      tdFiles.setAttribute('data-label', 'Файлы');
      tdFiles.appendChild(createFileLinks(key, data?.files));

      const tdTime = document.createElement('td');
      tdTime.className = 'timestamp';
      tdTime.setAttribute('data-label', 'Обновлено');
      const abs = document.createElement('span');
      abs.textContent = formatAbsolute(data?.database?.last_update);
      const rel = document.createElement('small');
      rel.textContent = formatRelative(data?.database?.last_update);
      tdTime.appendChild(abs);
      tdTime.appendChild(rel);
      tdTime.setAttribute('data-iso-updated', data?.database?.last_update || '');

      tr.append(tdVer, tdPlat, tdDb, tdSize, tdFiles, tdTime);
      frag.appendChild(tr);
    }

    body.replaceChildren(frag);
  }

  let relTimer = null;
  function tickRelative(root = document) {
    root.querySelectorAll('[data-iso-updated]').forEach(el => {
      const iso = el.getAttribute('data-iso-updated');
      const small = el.tagName === 'SMALL' ? el : el.querySelector('small');
      if (small) small.textContent = formatRelative(iso);
    });
  }

  function startRelativeTicker(root = document) {
    if (relTimer) clearInterval(relTimer);
    tickRelative(root);
    relTimer = setInterval(() => tickRelative(root), 60000);
  }

  (function initTooltipPortal() {
    const portal = els.tooltip;
    let anchor = null;
    let rafId = 0;

    function reveal() {
      portal.hidden = false;
      portal.style.visibility = 'visible';
      portal.style.opacity = '1';
    }

    function conceal() {
      portal.style.opacity = '0';
      portal.style.visibility = 'hidden';
      portal.hidden = true;
    }

    function placePortal({ withReveal = false } = {}) {
      if (!anchor) return;
      portal.style.left = '0px';
      portal.style.top = '0px';

      cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(() => {
        const r = anchor.getBoundingClientRect();
        const gap = 10;

        portal.hidden = false;
        const prevVis = portal.style.visibility;
        const prevOp = portal.style.opacity;
        portal.style.visibility = 'hidden';
        portal.style.opacity = '0';

        const pw = portal.offsetWidth;
        const ph = portal.offsetHeight;
        const vw = window.innerWidth;
        const vh = window.innerHeight;

        const upBottom = r.top - gap;
        const topIfUp = upBottom - ph;
        const canUp = topIfUp >= 8;

        let top;
        if (canUp) {
          top = topIfUp;
        } else {
          const downTop = r.bottom + gap;
          top = Math.min(downTop, vh - ph - 8);
        }

        const left = Math.min(
          Math.max(r.left + r.width / 2 - pw / 2, 8),
          vw - pw - 8
        );

        portal.style.left = `${left}px`;
        portal.style.top = `${top}px`;

        portal.style.visibility = prevVis || 'hidden';
        portal.style.opacity = prevOp || '0';

        if (withReveal) reveal();
      });
    }

    function showFor(el) {
      anchor = el;
      const text = el.getAttribute('aria-label') || el.dataset.tooltip || '';
      portal.textContent = text;

      portal.hidden = false;
      portal.style.visibility = 'hidden';
      portal.style.opacity = '0';

      placePortal({ withReveal: true });
    }

    function hide() {
      anchor = null;
      conceal();
    }

    document.addEventListener('mouseenter', (e) => {
      const t = e.target;
      if (t && t.classList && t.classList.contains('info-chip')) showFor(t);
    }, true);

    document.addEventListener('focusin', (e) => {
      const t = e.target;
      if (t && t.classList && t.classList.contains('info-chip')) showFor(t);
    });

    document.addEventListener('mouseleave', (e) => {
      const t = e.target;
      if (t && t.classList && t.classList.contains('info-chip')) hide();
    }, true);

    document.addEventListener('focusout', (e) => {
      const t = e.target;
      if (t && t.classList && t.classList.contains('info-chip')) hide();
    });

    window.addEventListener('scroll', () => { if (anchor) placePortal(); }, { passive: true });
    window.addEventListener('resize', () => { if (anchor) placePortal(); });

    const ro = new ResizeObserver(() => { if (anchor) placePortal(); });
    ro.observe(portal);
  })();

  let currentController = null;
  async function loadJSON(url) {
    if (currentController) {
      currentController.abort();
    }
    currentController = new AbortController();
    try {
      const res = await fetch(url, { cache: 'no-store', signal: currentController.signal });
      if (!res.ok) throw new Error(`Не удалось загрузить JSON: ${res.status}`);
      return await res.json();
    } finally {
      currentController = null;
    }
  }

  (async function init() {
    try {
      const metadata = await loadJSON(JSON_PATH);
      fillHeader(metadata);
      fillTable(metadata.versions ?? {});
      startRelativeTicker(document);
    } catch (error) {
      if (error?.name === 'AbortError') return;

      console.error(error);
      els.tbody.innerHTML = `
        <tr>
          <td colspan="6" style="text-align:center; padding:48px; color:#f87171;">
            Не удалось загрузить JSON: ${error.message}
          </td>
        </tr>
      `;
      els.versionsStatus.innerHTML = `
        <span style="font-size:12px;">●</span> Ошибка загрузки
      `;
    }
  })();
</script>
</body>
</html>
